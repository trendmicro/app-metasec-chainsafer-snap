{"version":3,"file":"initHandler.js","sourceRoot":"","sources":["../../../src/cmds/init/initHandler.ts"],"names":[],"mappings":";;;;;;AAAA,uDAM+B;AAC/B,2CAIyB;AACzB,2BAAoC;AACpC,gDAA6B;AAG7B,2CAQqB;AAErB,MAAM,iBAAiB,GAAG,MAAqB,CAAC;AAEhD;;;;;;;;;GASG;AACI,KAAK,UAAU,WAAW,CAAC,IAAe;IAC/C,MAAM,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC;IAE3B,MAAM,kBAAkB,GAAG,IAAA,6BAAqB,EAC9C,OAAO,CAAC,OAAwB,EAChC,iBAAiB,CAClB,CAAC;IAEF,IAAI,CAAC,kBAAkB,EAAE;QACvB,MAAM,IAAI,KAAK,CACb,0DAA0D,OAAO,CAAC,OAAO,4BAA4B,iBAAiB,GAAG,CAC1H,CAAC;KACH;IAED,MAAM,SAAS,GAAG,IAAA,0BAAc,GAAE,CAAC;IACnC,IAAI,CAAC,SAAS,EAAE;QACd,MAAM,IAAI,KAAK,CACb,mEAAmE,CACpE,CAAC;KACH;IAED,MAAM,cAAc,GAAG,SAAS;QAC9B,CAAC,CAAC,cAAS,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,SAAS,CAAC;QAC1C,CAAC,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC;IAElB,IAAA,qBAAO,EAAC,aAAa,cAAc,KAAK,CAAC,CAAC;IAE1C,MAAM,IAAA,mCAAuB,EAAC,cAAc,CAAC,CAAC;IAE9C,IAAI;QACF,IAAA,qBAAO,EAAC,qBAAqB,CAAC,CAAC;QAC/B,IAAA,yBAAa,EAAC,cAAc,CAAC,CAAC;QAE9B,MAAM,aAAE,CAAC,EAAE,CAAC,cAAS,CAAC,IAAI,CAAC,cAAc,EAAE,MAAM,CAAC,EAAE;YAClD,KAAK,EAAE,IAAI;YACX,SAAS,EAAE,IAAI;SAChB,CAAC,CAAC;KACJ;IAAC,OAAO,KAAK,EAAE;QACd,MAAM,IAAI,KAAK,CAAC,wCAAwC,CAAC,CAAC;KAC3D;IAED,IAAA,qBAAO,EAAC,4BAA4B,CAAC,CAAC;IACtC,IAAA,uBAAW,EAAC,cAAc,CAAC,CAAC;IAE5B,IAAI,CAAC,IAAA,6BAAiB,EAAC,cAAc,CAAC,EAAE;QACtC,IAAA,qBAAO,EAAC,gCAAgC,CAAC,CAAC;QAC1C,IAAA,mBAAO,EAAC,cAAc,CAAC,CAAC;KACzB;IAED,MAAM,YAAY,GAAG,cAAS,CAAC,IAAI,CAAC,cAAc,EAAE,yBAAa,CAAC,CAAC;IAEnE,MAAM,QAAQ,GAAG,CACf,MAAM,IAAA,0BAAY,EAAC,cAAS,CAAC,IAAI,CAAC,YAAY,EAAE,8BAAgB,CAAC,QAAQ,CAAC,CAAC,CAC5E,CAAC,MAAM,CAAC;IAET,MAAM,iBAAiB,GAAG,IAAA,gCAAkB,EAAC,QAAQ,CAAC,CAAC;IAEvD,MAAM,WAAW,GAAG,CAClB,MAAM,IAAA,0BAAY,EAChB,cAAS,CAAC,IAAI,CAAC,YAAY,EAAE,8BAAgB,CAAC,WAAW,CAAC,CAC3D,CACF,CAAC,MAA4B,CAAC;IAE/B,MAAM,QAAQ,GAAG,iBAAiB,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAE3E,OAAO;QACL,GAAG,IAAI;QACP,IAAI,EAAE,QAAQ,CAAC,CAAC,CAAC;QACjB,WAAW,EAAE,QAAQ,CAAC,CAAC,CAAC;QACxB,GAAG,EAAE,WAAW,CAAC,IAAI,IAAI,cAAc;QACvC,YAAY;KACb,CAAC;AACJ,CAAC;AAxED,kCAwEC","sourcesContent":["import {\n  NpmSnapFileNames,\n  readJsonFile,\n  NpmSnapPackageJson,\n  createSnapManifest,\n  logInfo,\n} from '@metamask/snaps-utils';\nimport {\n  satisfiesVersionRange,\n  SemVerRange,\n  SemVerVersion,\n} from '@metamask/utils';\nimport { promises as fs } from 'fs';\nimport pathUtils from 'path';\n\nimport { YargsArgs } from '../../types/yargs';\nimport {\n  cloneTemplate,\n  gitInit,\n  isGitInstalled,\n  isInGitRepository,\n  prepareWorkingDirectory,\n  SNAP_LOCATION,\n  yarnInstall,\n} from './initUtils';\n\nconst SATISFIED_VERSION = '>=16' as SemVerRange;\n\n/**\n * Creates a new snap package, based on one of the provided templates. This\n * creates all the necessary files, like `package.json`, `snap.config.js`, etc.\n * to start developing a snap.\n *\n * @param argv - The Yargs arguments object.\n * @returns The Yargs arguments augmented with the new `dist`, `outfileName` and\n * `src` properties.\n * @throws If initialization of the snap package failed.\n */\nexport async function initHandler(argv: YargsArgs) {\n  const { directory } = argv;\n\n  const isVersionSupported = satisfiesVersionRange(\n    process.version as SemVerVersion,\n    SATISFIED_VERSION,\n  );\n\n  if (!isVersionSupported) {\n    throw new Error(\n      `Init Error: You are using an outdated version of Node (${process.version}). Please update to Node ${SATISFIED_VERSION}.`,\n    );\n  }\n\n  const gitExists = isGitInstalled();\n  if (!gitExists) {\n    throw new Error(\n      `Init Error: git is not installed. Please install git to continue.`,\n    );\n  }\n\n  const directoryToUse = directory\n    ? pathUtils.join(process.cwd(), directory)\n    : process.cwd();\n\n  logInfo(`Preparing ${directoryToUse}...`);\n\n  await prepareWorkingDirectory(directoryToUse);\n\n  try {\n    logInfo(`Cloning template...`);\n    cloneTemplate(directoryToUse);\n\n    await fs.rm(pathUtils.join(directoryToUse, '.git'), {\n      force: true,\n      recursive: true,\n    });\n  } catch (error) {\n    throw new Error('Init Error: Failed to create template.');\n  }\n\n  logInfo('Installing dependencies...');\n  yarnInstall(directoryToUse);\n\n  if (!isInGitRepository(directoryToUse)) {\n    logInfo('Initializing git repository...');\n    gitInit(directoryToUse);\n  }\n\n  const snapLocation = pathUtils.join(directoryToUse, SNAP_LOCATION);\n\n  const manifest = (\n    await readJsonFile(pathUtils.join(snapLocation, NpmSnapFileNames.Manifest))\n  ).result;\n\n  const validatedManifest = createSnapManifest(manifest);\n\n  const packageJson = (\n    await readJsonFile(\n      pathUtils.join(snapLocation, NpmSnapFileNames.PackageJson),\n    )\n  ).result as NpmSnapPackageJson;\n\n  const distPath = validatedManifest.source.location.npm.filePath.split('/');\n\n  return {\n    ...argv,\n    dist: distPath[0],\n    outfileName: distPath[1],\n    src: packageJson.main || 'src/index.js',\n    snapLocation,\n  };\n}\n"]}