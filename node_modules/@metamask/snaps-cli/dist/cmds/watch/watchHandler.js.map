{"version":3,"file":"watchHandler.js","sourceRoot":"","sources":["../../../src/cmds/watch/watchHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  getOutfilePath,\n  logError,\n  logInfo,\n  validateDirPath,\n  validateFilePath,\n  validateOutfileName,\n} from '@metamask/snaps-utils';\nimport chokidar from 'chokidar';\n\nimport { YargsArgs } from '../../types/yargs';\nimport { loadConfig } from '../../utils';\nimport { bundle } from '../build/bundle';\nimport { evalHandler } from '../eval/evalHandler';\nimport { manifestHandler } from '../manifest/manifestHandler';\nimport { serve } from '../serve/serveHandler';\n\n/**\n * Watch a directory and its subdirectories for changes, and build when files\n * are added or changed.\n *\n * Ignores 'node_modules' and dotfiles.\n * Creates destination directory if it doesn't exist.\n *\n * @param argv - Arguments as an object generated by Yargs.\n * @param argv.src - The source file path.\n * @param argv.dist - The output directory path.\n * @param argv.'outfileName' - The output file name.\n */\nexport async function watch(argv: YargsArgs): Promise<void> {\n  const {\n    dist,\n    eval: shouldEval,\n    manifest,\n    outfileName,\n    src,\n    serve: shouldServe,\n  } = argv;\n  if (outfileName) {\n    validateOutfileName(outfileName);\n  }\n  await validateFilePath(src);\n  await validateDirPath(dist, true);\n  const rootDir = src.includes('/')\n    ? src.substring(0, src.lastIndexOf('/') + 1)\n    : '.';\n  const outfilePath = getOutfilePath(dist, outfileName);\n\n  const buildSnap = async (path?: string, logMessage?: string) => {\n    if (logMessage !== undefined) {\n      logInfo(logMessage);\n    }\n\n    try {\n      await bundle(src, outfilePath, argv, loadConfig().bundlerCustomizer);\n\n      if (manifest) {\n        await manifestHandler(argv);\n      }\n\n      if (shouldEval) {\n        await evalHandler({ ...argv, bundle: outfilePath });\n      }\n    } catch (error) {\n      logError(\n        `Error ${\n          path === undefined\n            ? 'during initial build'\n            : `while processing \"${path}\"`\n        }.`,\n        error,\n      );\n    }\n  };\n\n  chokidar\n    .watch(rootDir, {\n      ignoreInitial: true,\n      ignored: [\n        '**/node_modules/**',\n        `**/${dist}/**`,\n        `**/test/**`,\n        `**/tests/**`,\n        `**/*.test.js`,\n        `**/*.test.ts`,\n        /* istanbul ignore next */\n        (str: string) => str !== '.' && str.startsWith('.'),\n      ],\n    })\n\n    .on('ready', () => {\n      buildSnap()\n        .then(() => {\n          if (shouldServe) {\n            return serve(argv);\n          }\n\n          return undefined;\n        })\n        .catch((error) => {\n          logError('Error during initial build.', error);\n        });\n    })\n    .on('add', (path) => {\n      buildSnap(path, `File added: ${path}`).catch((error) => {\n        logError(`Error while processing \"${path}\".`, error);\n      });\n    })\n    .on('change', (path) => {\n      buildSnap(path, `File changed: ${path}`).catch((error) => {\n        logError(`Error while processing \"${path}\".`, error);\n      });\n    })\n    .on('unlink', (path) => logInfo(`File removed: ${path}`))\n    .on('error', (error: Error) => {\n      logError(`Watcher error: ${error.message}`, error);\n    })\n\n    .add(rootDir);\n\n  logInfo(`Watching '${rootDir}' for changes...`);\n}\n"]}